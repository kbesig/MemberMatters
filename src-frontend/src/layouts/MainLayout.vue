<template>
  <q-layout view="lHh Lpr lFf" :class="bgGradient ? 'bg-page-gradient' : ''">
    <q-header v-if="loggedIn || ($q.platform.is.mobile && loggedIn)" elevated>
      <q-banner
        v-if="features.siteBanner"
        class="bg-primary text-white text-center"
      >
        {{ features.siteBanner }}
      </q-banner>
      <q-toolbar class="bg-toolbar">
        <template v-if="$route.meta.backButton">
          <q-btn
            v-if="loggedIn && !Platform.is.electron"
            flat
            dense
            round
            :icon="icons.backButton"
            aria-label="Back"
            @click="handleBackPressed()"
          />
        </template>
        <template v-else>
          <q-btn
            v-if="loggedIn && !Platform.is.electron"
            flat
            dense
            round
            :icon="icons.menu"
            aria-label="Menu"
            @click="mainMenuOpen = !mainMenuOpen"
          />
        </template>

        <q-toolbar-title class="row">
          <template v-if="loggedIn">
            {{ toolbarTitle }}
          </template>
        </q-toolbar-title>

        <q-space v-if="$q.platform.is.electron" />

        <q-icon
          v-if="$q.platform.is.electron"
          class="rotate-90"
          :name="connected ? icons.rfid : icons.rfidSlash"
        />
      </q-toolbar>
    </q-header>

    <q-drawer v-if="loggedIn" v-model="mainMenuOpen" bordered class="column">
      <router-link :to="{ name: 'profile' }">
        <q-img
          spinner-color="white"
          class="absolute-top"
          :src="getBackground(images.menuBackground)"
          style="height: 150px"
        >
          <div class="absolute-bottom bg-transparent">
            <q-avatar size="56px" class="q-mb-sm">
              <q-icon :name="icons.profile" />
            </q-avatar>
            <div class="text-weight-bold">
              {{ profile.fullName }}
            </div>
            <div v-if="profile.screenName">({{ profile.screenName }})</div>
          </div>
        </q-img>
      </router-link>

      <q-scroll-area
        :style="
          $q.platform.is.capacitor
            ? 'margin-top: 110px; height: calc(100% - 190px);'
            : 'margin-top: 150px; height: calc(100% - 220px);'
        "
      >
        <q-list>
          <template v-for="link in filteredLinks" :key="link.title">
            <EssentialLink v-bind="link" />
          </template>
        </q-list>
      </q-scroll-area>

      <q-space />

      <div class="footer">
        <q-img
          fit="contain"
          :src="images.siteLogo"
          style="max-height: 40px; cursor: pointer"
          @click="aboutMemberMatters = true"
        />
      </div>
    </q-drawer>

    <q-page-container>
      <router-view v-slot="{ Component, route }">
        <!-- <transition
          :duration="1000"
          appear
          enter-active-class="animate_animated animate_bounce"
          leave-active-class="animate_animated animate_jello"
          mode="out-in"
        > -->
        <component :key="route.name" :is="Component" />
        <!-- </transition> -->
      </router-view>
    </q-page-container>

    <q-dialog v-model="aboutMemberMatters">
      <q-card>
        <q-card-section>
          <div class="text-h6">
            {{ $t('about.title') }}
          </div>
        </q-card-section>

        <q-card-section class="q-pt-none">
          {{ $t('about.description') }}
          <br /><br />
          <a
            :class="$q.dark.isActive ? 'text-white' : 'text-black'"
            href="https://github.com/membermatters/MemberMatters"
            target="_blank"
            >MemberMatters {{ $t('about.linkText') }}</a
          >
          <br />
          <a
            :class="$q.dark.isActive ? 'text-white' : 'text-black'"
            href="https://github.com/jabelone"
            target="_blank"
            >Jaimyn Mayer {{ $t('about.linkText') }}</a
          >
        </q-card-section>

        <q-card-actions align="right">
          <q-btn v-close-popup flat label="OK" color="primary-btn" />
        </q-card-actions>
      </q-card>
    </q-dialog>
  </q-layout>
</template>

<script lang="ts">
import EssentialLink from 'components/EssentialLink.vue';
import { mapActions, mapGetters } from 'vuex';
// import Transitions, { FadeTransition } from "vue2-transitions";
// import { FadeTransition } from "vue2-transitions";
// import Vue from "vue";
import { defineComponent } from 'vue';
import { Platform } from 'quasar';
import icons from '../icons';
import MainMenu from '../pages/pageAndRouteConfig';
import mainMixin from '../mixins/mainMixin';
import defaultBackground from '../assets/img/menu-bg/menu-bg.jpg';

// Vue.use(Transitions);

export default defineComponent({
  name: 'MainLayout',
  components: {
    EssentialLink,
  },
  mixins: [mainMixin],
  data() {
    return {
      mainMenuOpen: !!Platform.is.electron,
      essentialLinks: MainMenu,
      aboutMemberMatters: false,
    };
  },
  methods: {
    ...mapActions('profile', ['getProfile']),
    getBackground(path: string) {
      return path || defaultBackground;
    },
    handleBackPressed() {
      const backButton = this.$route.meta.backButton;
      if (backButton === true) this.$router.go(-1);
      else if (typeof backButton === 'string') this.$router.push(backButton);
    },
  },
  computed: {
    Platform() {
      return Platform;
    },
    ...mapGetters('profile', ['loggedIn', 'profile']),
    ...mapGetters('config', ['siteName', 'images', 'features']),
    ...mapGetters('rfid', ['connected']),
    bgGradient() {
      return this.$route.meta.bgGradient;
    },
    icons() {
      return icons;
    },
    toolbarTitle() {
      const nameKey = `menuLink.${this.$route.meta.title}`;
      const name = `${this.$t(nameKey)}`;
      return this.$route.meta.title ? name : this.$t('error.pageNotFound');
    },
    filteredLinks() {
      return this.essentialLinks.filter((link) => {
        let displayLink = true;

        if (link.loggedIn) {
          if (!this.loggedIn) displayLink = false;
        }
        if (!link.loggedIn) {
          if (this.loggedIn) displayLink = false;
        }
        if (link.memberOnly && this.profile.memberStatus !== 'active')
          displayLink = false;
        if (this.$q.platform.is.electron && !link.kiosk) displayLink = false;
        if (link.admin && !this.profile?.permissions?.staff) {
          displayLink = false;
        }

        return displayLink;
      });
    },
  },
  async mounted() {
    if (this.loggedIn) {
      await this.getProfile();
      if (
        this.profile.memberStatus === 'noob' &&
        this.$route.name !== 'membershipPlan' &&
        this.features.enableMembershipPayments
      ) {
        this.$router.push({ name: 'membershipPlan' });
      }
    }
  },
});
</script>

<style lang="sass" scoped>
.footer
  height: 50px
  text-align: center

  .q-scrollarea
    border-right: none!important

  .fade-enter-active, .fade-leave-active
    transition: opacity .3s

  .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */
    opacity: 0

// Fix for navigation list sometimes appearing blank
.q-scrollarea .q-scrollarea__content
  opacity: 1 !important

.q-list
  opacity: 1 !important
  transform: translateZ(0) // Force hardware acceleration
</style>
